<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ============================================ -->
    <!-- EQUIPMENT FORM VIEW -->
    <!-- ============================================ -->
    <record id="view_patrimoine_equipment_form" model="ir.ui.view">
        <field name="name">patrimoine.equipment.form</field>
        <field name="model">patrimoine.equipment</field>
        <field name="arch" type="xml">
            <form string="Équipement">
                <header>
                    <button name="action_set_available" string="Mettre Disponible"
                            type="object" class="oe_highlight"
                            attrs="{'invisible': [('state', 'in', ['available', 'retired'])]}"/>
                    <button name="action_set_in_use" string="Mettre En Utilisation"
                            type="object" class="oe_highlight"
                            attrs="{'invisible': [('state', 'in', ['in_use', 'retired'])]}"/>
                    <button name="action_set_maintenance" string="Mettre En Maintenance"
                            type="object"
                            attrs="{'invisible': [('state', 'in', ['maintenance', 'retired'])]}"/>
                    <button name="action_set_retired" string="Retirer"
                            type="object"
                            attrs="{'invisible': [('state', '=', 'retired')]}"/>
                    <button name="action_create_intervention" string="Créer Intervention"
                            type="object" class="btn-primary"
                            attrs="{'invisible': [('state', '=', 'retired')]}"/>
                    <field name="state" widget="statusbar"
                           statusbar_visible="draft,available,in_use,maintenance"/>
                </header>
                <sheet>
                    <widget name="web_ribbon" title="Archivé" bg_color="bg-danger"
                            attrs="{'invisible': [('active', '=', True)]}"/>
                    <widget name="web_ribbon" title="Sous Garantie" bg_color="bg-success"
                            attrs="{'invisible': [('is_under_warranty', '=', False)]}"/>

                    <field name="image" widget="image" class="oe_avatar"/>

                    <div class="oe_title">
                        <h1>
                            <field name="reference" readonly="1"/>
                        </h1>
                        <h2>
                            <field name="name" placeholder="Nom de l'équipement"/>
                        </h2>
                    </div>

                    <group>
                        <group string="Informations de Base">
                            <field name="category_id" options="{'no_create': False}"/>
                            <field name="sub_category"/>
                            <field name="barcode"/>
                            <field name="condition" widget="badge"
                                   decoration-success="condition == 'excellent'"
                                   decoration-info="condition == 'good'"
                                   decoration-warning="condition == 'fair'"
                                   decoration-danger="condition in ['poor', 'broken']"/>
                            <field name="active" invisible="1"/>
                            <field name="is_under_warranty" invisible="1"/>
                        </group>
                        <group string="Localisation">
                            <field name="location_id" options="{'no_create': False}"/>
                            <field name="building" readonly="1"/>
                            <field name="floor" readonly="1"/>
                        </group>
                    </group>

                    <group>
                        <group string="Responsabilité">
                            <field name="responsible_id" domain="[('active', '=', True)]"/>
                            <field name="assigned_to_id" domain="[('active', '=', True)]"/>
                        </group>
                        <group string="Identification Technique">
                            <field name="brand"/>
                            <field name="model"/>
                            <field name="serial_number"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Détails" name="details">
                            <group>
                                <field name="description" placeholder="Description de l'équipement..."/>
                                <field name="specifications" placeholder="Spécifications techniques détaillées..."/>
                            </group>
                        </page>

                        <page string="Acquisition" name="acquisition">
                            <group>
                                <group string="Achat">
                                    <field name="supplier_id" options="{'no_create': False}"/>
                                    <field name="purchase_date"/>
                                    <field name="currency_id" invisible="1"/>
                                    <field name="purchase_price"/>
                                    <field name="invoice_reference"/>
                                    <field name="activation_date"/>
                                </group>
                                <group string="Garantie">
                                    <field name="warranty_start_date"/>
                                    <field name="warranty_duration" widget="integer"/>
                                    <field name="warranty_end_date"/>
                                    <field name="is_under_warranty" widget="boolean"/>
                                </group>
                            </group>
                        </page>

                        <page string="Interventions" name="interventions">
                            <group>
                                <group>
                                    <field name="intervention_count"/>
                                    <field name="last_intervention_date"/>
                                    <field name="total_intervention_cost" widget="monetary"/>
                                </group>
                                <group string="Maintenance Préventive">
                                    <field name="requires_preventive_maintenance"/>
                                    <field name="maintenance_frequency"
                                           attrs="{'invisible': [('requires_preventive_maintenance', '=', False)]}"/>
                                    <field name="next_maintenance_date"
                                           attrs="{'invisible': [('requires_preventive_maintenance', '=', False)]}"
                                           widget="date"/>
                                </group>
                            </group>
                            <field name="intervention_ids" mode="tree">
                                <tree>
                                    <field name="reference"/>
                                    <field name="name"/>
                                    <field name="intervention_type"/>
                                    <field name="intervention_date"/>
                                    <field name="technician_id"/>
                                    <field name="state" decoration-info="state == 'draft'"
                                           decoration-warning="state == 'in_progress'"
                                           decoration-success="state == 'done'"/>
                                    <field name="total_cost"/>
                                </tree>
                            </field>
                            <div class="oe_chatter">
                                <button name="action_view_interventions" string="Voir Toutes"
                                        type="object" class="btn-primary"/>
                            </div>
                        </page>

                        <page string="Retrait" name="retirement" attrs="{'invisible': [('state', '!=', 'retired')]}">
                            <group>
                                <field name="retirement_date"/>
                                <field name="retirement_reason"/>
                            </group>
                        </page>

                        <page string="Notes" name="notes">
                            <field name="notes" placeholder="Notes supplémentaires..."/>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- ============================================ -->
    <!-- EQUIPMENT TREE VIEW -->
    <!-- ============================================ -->
    <record id="view_patrimoine_equipment_tree" model="ir.ui.view">
        <field name="name">patrimoine.equipment.tree</field>
        <field name="model">patrimoine.equipment</field>
        <field name="arch" type="xml">
            <tree string="Équipements" sample="1"
                  decoration-success="state == 'available'"
                  decoration-info="state == 'in_use'"
                  decoration-warning="state == 'maintenance'"
                  decoration-danger="state in ['repair', 'lost']"
                  decoration-muted="state == 'retired'">
                <field name="reference"/>
                <field name="name"/>
                <field name="barcode" optional="hide"/>
                <field name="category_id"/>
                <field name="location_id"/>
                <field name="building" optional="hide"/>
                <field name="assigned_to_id" optional="show"/>
                <field name="state" widget="badge"
                       decoration-success="state == 'available'"
                       decoration-info="state == 'in_use'"
                       decoration-warning="state == 'maintenance'"/>
                <field name="condition" widget="badge" optional="show"/>
                <field name="purchase_date" optional="hide"/>
                <field name="purchase_price" sum="Total" optional="hide"/>
                <field name="is_under_warranty" widget="boolean" optional="show"/>
                <field name="intervention_count" optional="show"/>
                <field name="total_intervention_cost" sum="Total" optional="hide"/>
            </tree>
        </field>
    </record>

    <!-- ============================================ -->
    <!-- EQUIPMENT KANBAN VIEW -->
    <!-- ============================================ -->
    <record id="view_patrimoine_equipment_kanban" model="ir.ui.view">
        <field name="name">patrimoine.equipment.kanban</field>
        <field name="model">patrimoine.equipment</field>
        <field name="arch" type="xml">
            <kanban sample="1">
                <field name="id"/>
                <field name="name"/>
                <field name="reference"/>
                <field name="category_id"/>
                <field name="location_id"/>
                <field name="state"/>
                <field name="condition"/>
                <field name="image"/>
                <field name="is_under_warranty"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click">
                            <div class="o_kanban_image">
                                <img t-att-src="kanban_image('patrimoine.equipment', 'image', record.id.raw_value)"
                                     alt="Equipment" class="o_image_64_cover"/>
                            </div>
                            <div class="oe_kanban_details">
                                <strong class="o_kanban_record_title">
                                    <field name="name"/>
                                </strong>
                                <div class="o_kanban_record_subtitle">
                                    <field name="reference"/>
                                </div>
                                <div>
                                    <field name="category_id"/>
                                </div>
                                <div>
                                    <i class="fa fa-map-marker"/> <field name="location_id"/>
                                </div>
                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left">
                                        <field name="state" widget="label"
                                               options="{'classes': {'available': 'success', 'in_use': 'info', 'maintenance': 'warning'}}"/>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <span t-if="record.is_under_warranty.raw_value" class="badge badge-success">
                                            <i class="fa fa-shield"/> Garantie
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ============================================ -->
    <!-- EQUIPMENT SEARCH VIEW -->
    <!-- ============================================ -->
    <record id="view_patrimoine_equipment_search" model="ir.ui.view">
        <field name="name">patrimoine.equipment.search</field>
        <field name="model">patrimoine.equipment</field>
        <field name="arch" type="xml">
            <search string="Rechercher Équipements">
                <field name="name" filter_domain="['|','|', ('name','ilike',self), ('reference','ilike',self), ('barcode','ilike',self)]"/>
                <field name="category_id"/>
                <field name="location_id"/>
                <field name="assigned_to_id"/>

                <filter string="Disponible" name="filter_available" domain="[('state','=','available')]"/>
                <filter string="En Utilisation" name="filter_in_use" domain="[('state','=','in_use')]"/>
                <filter string="En Maintenance" name="filter_maintenance" domain="[('state','=','maintenance')]"/>
                <filter string="En Réparation" name="filter_repair" domain="[('state','=','repair')]"/>

                <separator/>
                <filter string="Sous Garantie" name="filter_warranty" domain="[('is_under_warranty','=',True)]"/>
                <filter string="Maintenance Requise" name="filter_needs_maintenance"
                        domain="[('next_maintenance_date','&lt;=', context_today().strftime('%Y-%m-%d'))]"/>

                <separator/>
                <filter string="Archivé" name="filter_archived" domain="[('active','=',False)]"/>

                <group expand="0" string="Grouper par">
                    <filter string="Catégorie" name="group_category" context="{'group_by':'category_id'}"/>
                    <filter string="Localisation" name="group_location" context="{'group_by':'location_id'}"/>
                    <filter string="État" name="group_state" context="{'group_by':'state'}"/>
                    <filter string="Condition" name="group_condition" context="{'group_by':'condition'}"/>
                    <filter string="Assigné à" name="group_assigned" context="{'group_by':'assigned_to_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- ============================================ -->
    <!-- ACTIONS -->
    <!-- ============================================ -->
    <record id="action_patrimoine_equipment" model="ir.actions.act_window">
        <field name="name">Équipements</field>
        <field name="res_model">patrimoine.equipment</field>
        <field name="view_mode">kanban,tree,form,pivot,graph</field>
        <field name="search_view_id" ref="view_patrimoine_equipment_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Créer un nouvel équipement
            </p>
            <p>
                Commencez par ajouter les équipements de votre établissement.
            </p>
        </field>
    </record>

    <record id="action_patrimoine_equipment_available" model="ir.actions.act_window">
        <field name="name">Équipements Disponibles</field>
        <field name="res_model">patrimoine.equipment</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="domain">[('state', '=', 'available')]</field>
        <field name="context">{'search_default_filter_available': 1}</field>
    </record>

    <record id="action_patrimoine_equipment_in_use" model="ir.actions.act_window">
        <field name="name">Équipements En Utilisation</field>
        <field name="res_model">patrimoine.equipment</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="domain">[('state', '=', 'in_use')]</field>
        <field name="context">{'search_default_filter_in_use': 1}</field>
    </record>

    <record id="action_patrimoine_equipment_maintenance" model="ir.actions.act_window">
        <field name="name">Équipements En Maintenance</field>
        <field name="res_model">patrimoine.equipment</field>
        <field name="view_mode">tree,kanban,form</field>
        <field name="domain">[('state', 'in', ['maintenance', 'repair'])]</field>
        <field name="context">{'search_default_filter_maintenance': 1}</field>
    </record>
</odoo>
